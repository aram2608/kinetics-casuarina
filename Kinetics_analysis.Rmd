---
title: "Kinetics Analysis"
author: "Javier Arambula Rascon"
date: "2025-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

```{r}
# Downloading neccessary libraries
# install bioconductor packages
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
if (!requireNamespace("DESeq2", quietly = TRUE))
  BiocManager::install("DESeq2")
if (!requireNamespace("topGO", quietly = TRUE))
  BiocManager::install("topGO")
if (!requireNamespace("clusterProfiler", quietly = TRUE))
  BiocManager::install("clusterProfiler")
if (!requireNamespace("KEGGREST", quietly = TRUE))
  BiocManager::install("KEGGREST")
# install CRAN packages
if (!requireNamespace("ggVennDiagram", quietly = TRUE))
  install.packages("ggVennDiagram")
if (!requireNamespace("ggplot2", quietly = TRUE))
  install.packages("ggplot2")
if (!requireNamespace("dplyr", quietly = TRUE))
  install.packages("dplyr")
if (!requireNamespace("pheatmap", quietly = TRUE))
  install.packages("pheatmap")
if (!requireNamespace("tidyr", quietly = TRUE))
  install.packages("tidyr")
if (!requireNamespace("enrichplot", quietly = TRUE))
  install.packages("enrichplot")
if (!requireNamespace("ggrepel", quietly = TRUE))
  install.packages("ggrepel")
if (requireNamespace("progress", quietly = ))
  install.packages("progress")
if (requireNamespace("ontologyIndex", quietly = TRUE))
  install.packages("ontologyIndex")
if (requireNamespace("readr", quietly = TRUE))
  install.packages("readr")
```

```{r, echo=FALSE,message=FALSE}
# load libraries
library("DESeq2")
library("ggplot2")
library("ggVennDiagram")
library("dplyr")
library("pheatmap")
library("topGO")
library("clusterProfiler")
library("tidyr")
library("enrichplot")
library("topGO")
library("ggrepel")
library("KEGGREST")
library("progress")
library("ontologyIndex")
library("readr")
```

# Loading in Counts matrix

```{r}
raw_data <- read.delim("kinetics_count_matrix.txt", sep = "\t", header = TRUE)
cleaned_data <- raw_data[-c(2,3,4,5,6)]

# creating final counts matrix with row names
counts <- cleaned_data[, -1] # removes first column
rownames(counts) <- cleaned_data[, 1] # sets row names using first column
```

# Creating Column Data

```{r}
coldata <- data.frame(
  ID = colnames(counts), # extracts our column names for ID column
  Treatment = c(
    "Nodule",
    "Nodule",
    "Nodule",
    "Fourteen",
    "Fourteen",
    "Fourteen",
    "Twentyone",
    "Twentyone",
    "Twentyone",
    "24hour",
    "24hour",
    "24hour",
    "48hour",
    "48hour",
    "48hour",
    "Four",
    "Four",
    "Four",
    "Seven",
    "Seven",
    "Seven",
    "control",
    "control",
    "control"
  ),
  stringsAsFactors = FALSE
)

rownames(coldata) <- coldata[,1]
```

# Running DESeq2

```{r}
# creating our base deseq data set
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = coldata,
                              design = ~ Treatment)
# setting the reference level to make comparisons
dds$Treatment <- relevel(dds$Treatment, ref = "control")

# running DEseq on our matrix
dds <- DESeq(dds)

# making our results dataframe
res <- results(dds)
```
# sanity check to make sure everything is kosher

```{r}
# prints results
res

# prints summary of results
summary(res)

# prints pairwise comparisons,useful double check
resultsNames(dds)
```
# PCA to guage variance and if samples are similar

```{r}
# making an output directory
dir.create("DEG_results", showWarnings = FALSE)

# VST transformation
vsd <- vst(dds, blind = TRUE)
pca_data <- plotPCA(vsd, intgroup = c("Treatment"), returnData = TRUE)
percent_var <- round(100 * attr(pca_data, "percentVar"))

# PCA plotting using ggplot2
pca <- ggplot(pca_data, aes(PC1, PC2, color = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  xlab(paste0("PC1: ", percent_var[1], "% variance")) +
  ylab(paste0("PC2: ", percent_var[2], "% variance")) +
  coord_fixed() +
  scale_color_brewer(palette = "Set1") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )

# save plot as a png
ggsave("DEG_results/pca_plot.png", plot = pca, width = 6, height = 6, dpi = 300)

# print to r markdown
pca
```

# Venn Diagram

There are a lot of comparisons so lets hope and pray this does not look bizarre

```{r}
# list to store genes
comparisons <- resultsNames(dds)[-1] # removes the first weird column
all_degs <- list()

# loop through pair-wise comparison
for (comp in comparisons) {
  res <- results(dds, name = comp) #saves results for each comparison
  sig <- res[which(res$padj < 0.05 & !is.na(res$padj)), ] # filter for p and NA

  all <- rownames(sig[abs(sig$log2FoldChange) > 1.5, ]) # filter for up-reg 1.5

  all_degs[[comp]] <- all # compile up-reg genes
}

# todos los genes arriba y abajo
all_venn <- ggVennDiagram(all_degs, label_alpha = 0, edge_size = 0.5,
                          label = "count",
                          label_size = 5
                          ) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "All Differentially Expressed Genes") +
  theme(text = element_text(size = 10),
        plot.title = element_text(size = 14, hjust = 0.5, face = "bold"))

# fixes the long labels
fixed_venn <- all_venn + scale_x_continuous(expand = expansion(mult = 0.2))

ggsave("DEG_results/all_DEGs_venn.png",
       plot = fixed_venn, width = 8, height = 6, dpi = 300)
# plot to markdown
fixed_venn
```
# Pairwise comparison extraction

```{r}
# run the following to find out the resultsNames
#resultsNames(dds)

# extracting results names
h24_control <- resultsNames(dds)[c(2)] # the last time I did this I used a pretty brutish method
h48_control <- resultsNames(dds)[c(3)]
four_control <- resultsNames(dds)[c(4)]
seven_control <- resultsNames(dds)[c(7)]
fourteen_control <- resultsNames(dds)[c(5)]
twentyone_control <- resultsNames(dds)[c(8)]
nodule_control <- resultsNames(dds)[c(6)]

# now we need to save results as a dataframe
res24hvc <- results(dds, name = h24_control)
res48hvc <- results(dds, name = h48_control)
res4dvc <- results(dds, name = four_control)
res7dvc <- results(dds, name = seven_control)
res14dvc <- results(dds, name = fourteen_control)
res21dvc <- results(dds, name = twentyone_control)
resnodvc <- results(dds, name = nodule_control)

#filter the data for NA values
res24hvc_df <- as.data.frame(res24hvc) %>% # pipe operator, the same as | foo | in bash
  filter(!is.na(log2FoldChange), !is.na(padj))

res48hvc_df <- as.data.frame(res48hvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))

res4dvc_df <- as.data.frame(res4dvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))

res7dvc_df <- as.data.frame(res7dvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))

res14dvc_df <- as.data.frame(res14dvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))

res21dvc_df <- as.data.frame(res21dvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))

resnodvc_df <- as.data.frame(resnodvc) %>%
  filter(!is.na(log2FoldChange), !is.na(padj))
```

# A little function to help with formatting hopefully

```{r}
formatting_func <- function(df, padj_cutoff = 0.05, lfc_cutoff = 1.5) {
  df$diffexpress <- "NO"
  df$diffexpress[df$padj < padj_cutoff & df$log2FoldChange > lfc_cutoff] <- "UP"
  df$diffexpress[df$padj < padj_cutoff & df$log2FoldChange < -lfc_cutoff] <- "DOWN"
  return(df)
}
```

# Hopefully this works nicely

```{r}
res24hvc_df <- formatting_func(res24hvc_df)
res48hvc_df <- formatting_func(res48hvc_df)
res4dvc_df <- formatting_func(res4dvc_df)
res7dvc_df <- formatting_func(res7dvc_df)
res14dvc_df <- formatting_func(res14dvc_df)
res21dvc_df <- formatting_func(res21dvc_df)
resnodvc_df <- formatting_func(resnodvc_df)
```

# Volcano plot function

```{r}
volcano_plotter <- function(df, title) {
  volc_plot <- ggplot(data = df, 
                      aes(x = log2FoldChange, 
                          y = -log10(padj), 
                          col = diffexpress)) +
    geom_vline(xintercept = c(-1.5, 1.5), col = "gray", linetype = "dashed") +
    geom_hline(yintercept = -log10(0.05), col = "gray", linetype = "dashed") +
    geom_point(size = 2) +
    scale_color_manual(values = c("blue","grey","red"),
                       labels = c("Downregulated", "Not significant", "Upregulated")) +
    coord_cartesian(ylim = c(0, 40), xlim = c(-10, 10)) +
    labs(color = "Legend", 
       x = expression("log"[2]*"FC"), 
       y = expression("-log"[10]*"Adjusted p-value")) +
  ggtitle(title)
  return(volc_plot)
}
```


# Volcano plots

```{r}
volc_24hvc <- volcano_plotter(res24hvc_df, "24 Hours vs. Control")
volc_48vc <- volcano_plotter(res48hvc_df, "48 Hours vs. Control")
volc_4vc <- volcano_plotter(res4dvc_df, "4 Days vs. Control")
volc_7vc <- volcano_plotter(res7dvc_df, "7 Days vs. Control")
volc_14vc <- volcano_plotter(res14dvc_df, "14 Days vs. Control")
volc_21vc <- volcano_plotter(res21dvc_df, "21 Days vs. Control")
volc_nvc <- volcano_plotter(resnodvc_df, "Nodules vs. Control")
```

# Volc Plots

```{r}
volc_24hvc
volc_48vc
volc_4vc
volc_7vc
volc_14vc
volc_21vc
volc_nvc
```

# Load in annotations

```{r}
annotation_data <- read.delim("dups_removed.tsv", sep = "\t")
```

# Function to extract rownames and assign a column called Gene Ids

```{r}
gene_id_grabber <- function(df) {
  df$gene_ids <- rownames(df)
  return(df)
}

#res7v4_df$gene_ids <- rownames(res7v4_df)
#res14v4_df$gene_ids <- rownames(res14v4_df)
#res21v4_df$gene_ids <- rownames(res21v4_df)
#resNv4_df$gene_ids <- rownames(resNv4_df)
```

# Creating a column for Gene Ids

```{r}
res24hvc_df <- gene_id_grabber(res24hvc_df)
res48hvc_df <- gene_id_grabber(res48hvc_df)
res4dvc_df <- gene_id_grabber(res4dvc_df)
res7dvc_df <- gene_id_grabber(res7dvc_df)
res14dvc_df <- gene_id_grabber(res14dvc_df)
res21dvc_df <- gene_id_grabber(res21dvc_df)
resnodvc_df <- gene_id_grabber(resnodvc_df)
```


# Creating GO term universe

```{r}
# extracting goterms from eggnog mapper annotations
go_terms <- annotation_data[c(1,10)]
go_terms <- go_terms[go_terms$GOs != "-",] # removes terms with no hit

# exporting out go terms to create mappings
write.table(go_terms, file = "go_terms.tsv", sep = "\t", quote = FALSE, row.names = FALSE)

# importing back in as gene2gomappings
gene2goMappings <- readMappings(file = "go_terms.tsv", sep = "\t", IDsep = ",")
```

# Function to merge GO terms to DEGs

```{r}
go_add <- function(df, go_terms) {
  df <- merge(df, go_terms[,c("query", "GOs")], by.x = "gene_ids", by.y = "query", all.x = TRUE)
  df <- df[!is.na(df$GOs),] # filter out terms that have no GO term
  df <- df %>%
    filter(abs(log2FoldChange) > 1.5) # filter by FoldChange both upregulated and downregulated
  return(df)
}
```

# Merging GO terms to DEGs

```{r}
go_24hvc <- go_add(res24hvc_df, go_terms)
go_48hvc <- go_add(res48hvc_df, go_terms)
go_4vc <- go_add(res4dvc_df, go_terms)
go_7vc <- go_add(res7dvc_df, go_terms)
go_14vc <- go_add(res14dvc_df, go_terms)
go_21vc <- go_add(res21dvc_df, go_terms)
go_nodvc <- go_add(resnodvc_df, go_terms)
```

# Function for extracting gene_ids and creating custom mappings for topGO

```{r}
go_filter_func <- function(df) {
  filtered_df <- dplyr::select(df, gene_ids,padj) # selects columns of interest
  sorted_df <- filtered_df[order(filtered_df$padj),] # sorts by adjusted p value
  top_df <- sorted_df$padj # creates a vector? with the padj values
  names(top_df) <- sorted_df$gene_ids # assigns names to the padj values
  return(top_df)
}
```

# Creating GO mappings

```{r}
top_24hvc <- go_filter_func(go_24hvc)
top_48hvc <- go_filter_func(go_48hvc)
top_4vc <- go_filter_func(go_4vc)
top_7vc <- go_filter_func(go_7vc)
top_14vc <- go_filter_func(go_14vc)
top_21vc <- go_filter_func(go_21vc)
top_nodvc <- go_filter_func(go_nodvc)
```

# Analysis parameters

```{r}
# pval cuttoff
cuttof_padj <- 0.05

# filtering function
topgo_filter <- function(x) {
  return(x <= cuttof_padj)
}
```

# Functions to create go data objects

```{r, echo=FALSE,message=FALSE}
bio_process <- function(top_vector) {
  top_go_object <- new(
    "topGOdata",
    ontology = "BP",
    allGenes = top_vector,
    annot = annFUN.gene2GO,
    geneSel = topgo_filter,
    gene2GO = gene2goMappings
  )
  return(top_go_object)
}
```

# Making our go data objects

```{r, echo=FALSE,message=FALSE}
bp_24hvc <- bio_process(top_24hvc)
bp_48hvc <- bio_process(top_48hvc)
bp_4vc <- bio_process(top_14vc)
bp_7vc <- bio_process(top_7vc)
bp_14vc <- bio_process(top_14vc)
bp_21vc <- bio_process(top_21vc)
bp_nodvc <- bio_process(top_nodvc)
```

# Enrichment functions

```{r}
elim_fisher <- function(go_data_object) {
  fisher_result <- runTest(go_data_object, algorithm = "elim", statistic = "fisher")
  return(fisher_result)
}
```

# Running enrichment tests

```{r, message=FALSE, echo=FALSE}
fish_bp24hvc <- elim_fisher(bp_24hvc)
fish_bp48hvc <- elim_fisher(bp_48hvc)
fish_bp4vc <- elim_fisher(bp_4vc)
fish_bp7vc <- elim_fisher(bp_7vc)
fish_bp14vc <- elim_fisher(bp_14vc)
fish_bp21vc <- elim_fisher(bp_21vc)
fish_nodvc <- elim_fisher(bp_nodvc)
```

# Generating tables for plotting

```{r}
# Function to generate a nicely formatted enrichment table
get_enrich_table <- function(go_obj, fisher_result, top_n = 10, total_genes = NULL) {
  tab <- GenTable(go_obj,
                  classicFisher = fisher_result,
                  orderBy = "classicFisher", # orders results by sig p-values
                  ranksOf = "classicFisher",
                  topNodes = top_n) %>%
    mutate(
      pvalue = as.numeric(classicFisher),
      Term = factor(Term, levels = rev(Term)),
      Count = as.numeric(Significant),
      GeneRatio = if (!is.null(total_genes)) Count / total_genes else NA_real_
    ) %>%
    select(Term, Count, GeneRatio, pvalue, everything()) %>%
    arrange(pvalue)

  return(tab)
}
```

# Tables

```{r}
tab_bp24hvc <- get_enrich_table(bp_24hvc, fish_bp24hvc)
tab_bp48hvc <-get_enrich_table(bp_48hvc, fish_bp48hvc)
tab_bp4vc <- get_enrich_table(bp_4vc, fish_bp4vc)
tab_bp7vc <- get_enrich_table(bp_7vc, fish_bp7vc)
tab_bp14vc <- get_enrich_table(bp_14vc, fish_bp14vc)
tab_bp21vc <- get_enrich_table(bp_21vc, fish_bp21vc)
tab_bpnodvc <- get_enrich_table(bp_nodvc, fish_nodvc)
```

# Plotting function

```{r}
# plotting function
plot_enrich_bar <- function(enrich_tab, title) {
  enrich_tab <- enrich_tab %>%
    mutate(
      Term = factor(Term, levels = rev(unique(Term))),  # keep in plotted order
      Count = as.numeric(Count),
      pvalue = as.numeric(pvalue)
    ) %>%
    filter(pvalue < 0.05) %>% # filters out non-significant genes
    arrange(pvalue) # arranges bars by p-value

  ggplot(enrich_tab, aes(x = Count, y = Term, fill = pvalue)) +
    geom_bar(stat = "identity") +
    scale_fill_gradient(low = "red", high = "blue", name = "p.adjust") +
    labs(
      title = title,
      x = "Gene Count",
      y = NULL
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      axis.text.y = element_text(size = 10),
      axis.title.x = element_text(size = 12),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 9)
    )
}
```

# Go term plots

```{r}
enrich_bp24hvc <- plot_enrich_bar(tab_bp24hvc, "24H BP")
enrich_bp48hvc <- plot_enrich_bar(tab_bp48hvc, "48H BP")
enrich_bp4vc <- plot_enrich_bar(tab_bp4vc, "4 Day BP")
enrich_bp7vc <- plot_enrich_bar(tab_bp7vc, "7 Day BP")
enrich_bp14vc <- plot_enrich_bar(tab_bp14vc, "14 Day BP")
enrich_bp21vc <- plot_enrich_bar(tab_bp21vc, "21 Day BP")
enrich_bpnodvc <- plot_enrich_bar(tab_bpnodvc, "Nodule BP")
```

# Plot to markdown

```{r}
enrich_bp24hvc
enrich_bp48hvc
enrich_bp4vc
enrich_bp7vc
enrich_bp14vc
enrich_bp21vc
enrich_bpnodvc
```

# Gonna try clusterprofiler as well, Prepping term to gene table

```{r}
go_tab_cluster <- go_terms %>%
  separate_rows(GOs, sep = ",") %>%
  mutate(gene = gsub("\\..*", "", query)) %>%
  select(GOs, gene) %>%
  distinct() %>%
  drop_na()
colnames(go_tab_cluster) <- c("term", "gene")
```

# Prepping term to name table

```{r}
ontology <- get_ontology(file = "go.obo",
                         propagate_relationships = "is_a",
                         extract_tags = "everything",
                         merge_equivalent_terms = TRUE)

go_term_clust <- go_tab_cluster %>%
    mutate(name = ontology$name[term]) %>%
    select(c(term, name)) %>%
    distinct() %>%
    drop_na() %>%
    filter(!grepl("obsolete", name))

go_tab_cluster <- go_tab_cluster %>%
    filter(term %in% go_term_clust$term)
```

# Creating background genes and term mapping files

```{r}
background_genes <- cleaned_data %>%
  dplyr::select(Geneid) %>%
  unlist() %>%
  as.vector()

write_tsv(x = go_tab_cluster, file = "term2gene_GO.tsv")
write_tsv(x =go_term_clust, file = "term2name_GO.tsv")
```

# Filter function for ORA

```{r}
interesting_gene_filter <- function(df) {
  interesting_set <- df %>%
    filter(!is.na(log2FoldChange), !is.na(padj)) %>%
    filter(abs(log2FoldChange) > 1.5 & padj <= 0.05) %>%
    dplyr::select(gene_ids) %>%
    unlist() %>%
    as.vector()
  return(interesting_set)
}
```

# Filtering for set of interest

```{r}
interest_24hvc <- interesting_gene_filter(res24hvc_df)
interest_48hvc <- interesting_gene_filter(res48hvc_df)
interest_4dvc <- interesting_gene_filter(res4dvc_df)
interest_7dvc <- interesting_gene_filter(res7dvc_df)
interest_14dvc <- interesting_gene_filter(res14dvc_df)
interest_21dvc <- interesting_gene_filter(res21dvc_df)
interest_nodsvc <- interesting_gene_filter(resnodvc_df)
```

# Loading in mappings

```{r, echo=FALSE, message=FALSE}
term2name <- read_tsv("term2name_GO.tsv")
term2gene <- read_tsv("term2gene_GO.tsv")
```

# Enrichment function

```{r}
enrichment <- function(interesting_genes) {
  enrich_object <- enricher(
    interesting_genes,
    TERM2GENE = term2gene,
    TERM2NAME = term2name,
    pvalueCutoff = 0.05,
    pAdjustMethod = "BH",
    universe = background_genes,
    qvalueCutoff = 0.05
  )
}
```

# Running our enrichment test

```{r}
encriched_24hvc <- enrichment(interest_24hvc)
enriched_48hvc <- enrichment(interest_48hvc)
enriched_4dvc <- enrichment(interest_4dvc)
enriched_7dvc <- enrichment(interest_7dvc)
enriched_14dvc <- enrichment(interest_14dvc)
enriched_21dvc <- enrichment(interest_21dvc)
enriched_nodvc <- enrichment(interest_nodsvc)
```

# Plotting func

```{r}
cluster_plot_func <- function(enrich_result, title) {
    p <- dotplot(enrich_result,
                 x= "geneRatio", # Options: GeneRatio, BgRatio, pvalue, p.adjust, qvalue
                 color="p.adjust",
                 orderBy = "x", # Options: GeneRatio, BgRatio, pvalue, p.adjust, qvalue
                 showCategory=10,
                 font.size=8) +
        ggtitle(title)
  return(p)
}
```

#Plotting results

```{r}
enriched_p24hvc <- cluster_plot_func(encriched_24hvc, "Enriched GO Terms 24H")
enriched_p48hvc <- cluster_plot_func(enriched_48hvc, "Enriched GO Terms 48H")
enriched_p4dvc <- cluster_plot_func(enriched_4dvc, "Enriched GO Terms 4 Days")
enriched_p7dvc <- cluster_plot_func(enriched_7dvc, "Enriched GO Terms 7 Days")
enriched_p14dvc <- cluster_plot_func(enriched_14dvc, "Enriched GO Terms 14 Days")
enriched_p21dvc <- cluster_plot_func(enriched_21dvc, "Enriched GO Terms 21 Days")
enriched_pnodvc <- cluster_plot_func(enriched_nodvc, "Enriched GO Terms Nodules")
```

# Plot to markdown

```{r}
enriched_p24hvc
enriched_p48hvc
enriched_p4dvc
enriched_p7dvc
enriched_p14dvc
enriched_p21dvc
enriched_pnodvc
```

# Load in annotations

```{r, echo=FALSE,message=FALSE}
diamond_hits <- read_tsv("diamond_dups_removed.tsv")
```

# Add annotations to results frames, function

```{r}
diamond_add <- function(resdf, diamond_df) {
  resdf <- merge(resdf, diamond_df[,c("query", "GOs")], by.x = "gene_ids", by.y = "query", all.x = TRUE)
}
```

